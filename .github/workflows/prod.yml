# Deploys a website in production at https://py.amsterdam
name: website-production
on:
  push:
    branches:
      - master
jobs:
  prod:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: actions/setup-python@v6
        with:
          python-version: '3.8' # Version range or exact version of a Python version to use, using SemVer's version range syntax
          architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified
      - name: "pelican"
        run: |
          pip3 install -U pip
          pip3 install setuptools
          pip3 install wheel
          pip3 install -r requirements.txt
          make prod
      - name: Install Vercel CLI
        run: npm install --global vercel@33
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -euo pipefail
          DEPLOY_LOG=$(mktemp)
          vercel deploy ./output --prod --yes --token "$VERCEL_TOKEN" | tee "$DEPLOY_LOG"
          DEPLOY_URL=$(grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' "$DEPLOY_LOG" | tail -n1)
          if [ -z "$DEPLOY_URL" ]; then
            echo "Unable to extract deployment URL from Vercel output"
            exit 1
          fi
          echo "Production deployment: $DEPLOY_URL"
